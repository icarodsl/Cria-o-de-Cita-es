<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Cita√ß√µes Inspiradoras (Gemini API)</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o r√°pida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .quote-container {
            min-height: 150px;
        }
        .quote-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
        .copy-button {
            transition: background-color 0.3s, transform 0.1s;
        }
        .copy-button:active {
            transform: scale(0.98);
        }
        /* Estilos para o item do hist√≥rico */
        .history-item {
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .history-item:hover {
            background-color: #f0f4f8;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-start justify-center min-h-screen">

    <!-- Container Principal Flex√≠vel -->
    <div class="w-full max-w-4xl flex flex-col lg:flex-row gap-6">

        <!-- Coluna Esquerda: Gerador (Ocupa mais espa√ßo) -->
        <div class="lg:w-3/5 bg-white p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-100">
            
            <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-2">
                ‚ú® Gerador de Cita√ß√µes Personalizadas
            </h1>
            <p class="text-center text-gray-500 mb-6">
                Defina o tema, o estilo e o toque visual da sua inspira√ß√£o para Suzane.
            </p>

            <!-- Controles de Personaliza√ß√£o -->
            <div class="space-y-4 mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                <h2 class="text-xl font-semibold text-blue-700 mb-3">Controles Criativos</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Assunto -->
                    <div>
                        <label for="topic-input" class="block text-sm font-medium text-gray-700 mb-1">Assunto da Cita√ß√£o:</label>
                        <input type="text" id="topic-input" placeholder="Ex: Inova√ß√£o, Amizade, O futuro..." value="Amor expresso em voz alta"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm">
                    </div>

                    <!-- Tom/Estilo -->
                    <div>
                        <label for="style-input" class="block text-sm font-medium text-gray-700 mb-1">Tom/Estilo:</label>
                        <select id="style-input"
                                class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm">
                            <option value="Po√©tico e Profundo">Po√©tico e Profundo (Padr√£o)</option>
                            <option value="Direto e Motivacional">Direto e Motivacional</option>
                            <option value="C√¥mico e Leve">C√¥mico e Leve</option>
                            <option value="Filos√≥fico e Reflexivo">Filos√≥fico e Reflexivo</option>
                        </select>
                    </div>
                </div>

                <!-- Seletor de √çcone -->
                <div>
                    <label for="icon-input" class="block text-sm font-medium text-gray-700 mb-1">√çcone Decorativo:</label>
                    <select id="icon-input"
                            class="w-full p-3 border border-gray-300 rounded-lg bg-white text-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm">
                        <option value="üí°">üí° (Ideia)</option>
                        <option value="‚ù§Ô∏è">‚ù§Ô∏è (Cora√ß√£o)</option>
                        <option value="‚ú®" selected>‚ú® (Brilho)</option>
                        <option value="üå±">üå± (Crescimento)</option>
                        <option value="üöÄ">üöÄ (Inova√ß√£o)</option>
                        <option value="üß†">üß† (Mente)</option>
                        <option value="üïäÔ∏è">üïäÔ∏è (Paz)</option>
                    </select>
                </div>
            </div>
            
            <!-- Cont√™iner de Exibi√ß√£o da Cita√ß√£o -->
            <div id="quote-container" class="quote-container bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6 flex items-center justify-center text-center shadow-inner">
                <p id="quote-text" class="quote-text text-xl italic text-gray-600 font-medium">
                    Defina sua inspira√ß√£o e clique em "Gerar Cita√ß√£o".
                </p>
            </div>

            <!-- Mensagem de Status (Carregamento / Erro) -->
            <div class="min-h-[20px] mb-4 text-center">
                <p id="status-message" class="text-blue-600 text-sm font-semibold"></p>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                
                <!-- Bot√£o Gerar Nova Cita√ß√£o -->
                <button id="generate-button" onclick="generateQuote()" 
                        class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500/50 transition ease-in-out duration-150">
                    Gerar Cita√ß√£o Personalizada
                </button>
                
                <!-- Bot√£o Copiar -->
                <button id="copy-button" onclick="copyQuote()" disabled
                        class="copy-button w-full py-3 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-500/50 transition ease-in-out duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                    Copiar Cita√ß√£o
                </button>
            </div>
            
            <!-- Mensagem de Copiado (Aparece ao clicar em Copiar) -->
            <p id="copy-message" class="mt-4 text-center text-sm font-semibold text-green-600 opacity-0 transition-opacity duration-300"></p>

        </div>
        
        <!-- Coluna Direita: Hist√≥rico (Ocupa menos espa√ßo) -->
        <div class="lg:w-2/5 bg-white p-6 sm:p-6 rounded-2xl shadow-2xl border border-gray-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2 text-xl">üíæ</span> Hist√≥rico de Cita√ß√µes Recentes
            </h2>
            <div id="history-list" class="space-y-3">
                <p id="empty-history" class="text-gray-500 italic text-sm">Nenhuma cita√ß√£o salva ainda.</p>
                <!-- Cita√ß√µes ser√£o injetadas aqui -->
            </div>
            <button id="clear-history-button" onclick="clearHistory()"
                    class="mt-4 w-full py-2 text-sm text-red-600 border border-red-300 rounded-lg hover:bg-red-50 transition duration-150">
                Limpar Hist√≥rico
            </button>
        </div>

    </div>

    <script type="module">
        // Vari√°veis globais para configura√ß√£o da API
        // *** CHAVE API INSERIDA AQUI ***
        // A chave fornecida pelo usu√°rio est√° inserida abaixo para garantir o funcionamento local.
        const apiKey = "AIzaSyCaSuwB8GrfLyuBz7t3k3nrUJL7SzCCme8"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Chave do localStorage para o hist√≥rico
        const HISTORY_STORAGE_KEY = 'gemini_quote_history';
        const MAX_HISTORY_ITEMS = 5;

        // Elementos do DOM
        const quoteTextElement = document.getElementById('quote-text');
        const statusMessageElement = document.getElementById('status-message');
        const generateButton = document.getElementById('generate-button');
        const copyButton = document.getElementById('copy-button');
        const copyMessageElement = document.getElementById('copy-message');
        const historyListElement = document.getElementById('history-list');
        const emptyHistoryMessage = document.getElementById('empty-history');
        const clearHistoryButton = document.getElementById('clear-history-button');
        
        // Elementos de input
        const topicInput = document.getElementById('topic-input');
        const styleInput = document.getElementById('style-input');
        const iconInput = document.getElementById('icon-input'); 


        // --- Fun√ß√µes de Hist√≥rico (localStorage) ---

        // Carrega o hist√≥rico do localStorage
        function loadHistory() {
            try {
                const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
                return historyJson ? JSON.parse(historyJson) : [];
            } catch (e) {
                console.error("Erro ao carregar hist√≥rico do localStorage:", e);
                return [];
            }
        }

        // Salva a nova cita√ß√£o no hist√≥rico
        function saveQuoteToHistory(quoteWithIcon) {
            const history = loadHistory();
            
            // Adiciona a nova cita√ß√£o ao topo do array
            history.unshift(quoteWithIcon);
            
            // Limita o tamanho do hist√≥rico
            const limitedHistory = history.slice(0, MAX_HISTORY_ITEMS);
            
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(limitedHistory));
                displayHistory(limitedHistory); // Atualiza a exibi√ß√£o imediatamente
            } catch (e) {
                console.error("Erro ao salvar hist√≥rico no localStorage:", e);
            }
        }
        
        // Exibe o hist√≥rico na UI
        function displayHistory(history) {
            historyListElement.innerHTML = ''; // Limpa a lista
            
            if (history.length === 0) {
                emptyHistoryMessage.style.display = 'block';
                clearHistoryButton.style.display = 'none';
                return;
            }

            emptyHistoryMessage.style.display = 'none';
            clearHistoryButton.style.display = 'block';

            history.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item p-3 rounded-lg border border-gray-200 text-sm text-gray-700 truncate';
                historyItem.textContent = item;
                historyItem.title = item; // Dica de ferramenta
                
                // Adiciona a funcionalidade de clique para copiar
                historyItem.onclick = () => {
                    copyTextToClipboard(item, true); // Copia o item
                };

                historyListElement.appendChild(historyItem);
            });
        }
        
        // Limpa todo o hist√≥rico
        window.clearHistory = function() {
            localStorage.removeItem(HISTORY_STORAGE_KEY);
            displayHistory([]);
            // Opcional: Limpar a cita√ß√£o principal
            quoteTextElement.textContent = 'Defina sua inspira√ß√£o e clique em "Gerar Cita√ß√£o".';
            updateUI(false, 'Hist√≥rico limpo.');
        }


        // --- Fun√ß√µes de Utilidade (UI e API) ---

        // Fun√ß√£o para atualizar o status da UI
        function updateUI(isLoading, message = '') {
            generateButton.disabled = isLoading;
            generateButton.textContent = isLoading ? 'Gerando...' : 'Gerar Cita√ß√£o Personalizada';
            statusMessageElement.textContent = message;
            
            const isQuotePresent = quoteTextElement.textContent.trim() !== '' && 
                                   !quoteTextElement.textContent.includes('Defina sua inspira√ß√£o') &&
                                   !quoteTextElement.textContent.includes('ERRO') &&
                                   !quoteTextElement.textContent.includes('vazio') &&
                                   !quoteTextElement.textContent.includes('Chave API ausente') &&
                                   !quoteTextElement.textContent.includes('bloqueada'); // Adiciona verifica√ß√£o para mensagem de bloqueio
            
            copyButton.disabled = isLoading || !isQuotePresent;
        }

        // Fun√ß√£o para realizar a chamada √† API com retries (Backoff Exponencial)
        async function fetchWithExponentialBackoff(payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response.json();
                    }

                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`API error with status ${response.status}. Retrying...`);
                    } else {
                        const errorBody = await response.json();
                        // Trata erros de formato JSON inv√°lido que podem retornar status 400
                        throw new Error(`API failed: ${errorBody.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Fun√ß√£o para copiar o texto para a √°rea de transfer√™ncia
        function copyTextToClipboard(text, isHistory = false) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            
            tempInput.select();
            tempInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                
                // Feedback visual para o usu√°rio
                copyMessageElement.textContent = isHistory ? '‚úÖ Cita√ß√£o do hist√≥rico copiada!' : '‚úÖ Copiado para a √°rea de transfer√™ncia!';
                copyMessageElement.style.opacity = '1';

                setTimeout(() => {
                    copyMessageElement.style.opacity = '0';
                }, 3000);

            } catch (err) {
                copyMessageElement.textContent = '‚ùå Falha ao copiar. Tente selecionar o texto manualmente.';
                copyMessageElement.style.opacity = '1';
                console.error('Erro ao copiar:', err);
            }

            document.body.removeChild(tempInput);
        }

        // Fun√ß√£o principal para gerar a cita√ß√£o
        window.generateQuote = async function() {
            if (apiKey === "") {
                quoteTextElement.textContent = 'ERRO DE CONFIGURA√á√ÉO: Insira sua Chave API no c√≥digo para uso externo.';
                updateUI(false, 'Chave API ausente.');
                return;
            }

            const topic = topicInput.value.trim();
            const style = styleInput.value;
            const icon = iconInput.value; 

            if (!topic) {
                updateUI(false, 'Por favor, insira um assunto para a cita√ß√£o.');
                quoteTextElement.textContent = 'O assunto da cita√ß√£o n√£o pode estar vazio.';
                return;
            }

            updateUI(true, `Gerando cita√ß√£o sobre "${topic}" no estilo "${style}"...`);
            quoteTextElement.textContent = '';
            copyMessageElement.style.opacity = '0';

            // 1. Cria a instru√ß√£o do sistema
            // Lembrete: O sistema de instru√ß√£o mant√©m a personaliza√ß√£o para Suzane
            const systemPrompt = `Voc√™ √© um mentor de vida e filosofia focado em criar cita√ß√µes de amor e carinho, pois a cita√ß√£o ser√° usada para uma surpresa rom√¢ntica para Suzane, que gosta de se sentir amada em voz alta. Sua tarefa √© criar uma cita√ß√£o inspiradora √∫nica e motivacional, com um toque ${style}. A cita√ß√£o deve ter no m√°ximo duas frases. Formate a sa√≠da como um bloco de texto simples, sem aspas, nomes de autor ou qualquer introdu√ß√£o.`;
            
            // 2. Cria a consulta do usu√°rio baseada no input
            const userQuery = `Gere uma cita√ß√£o original sobre o assunto: "${topic}".`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: { 
                    temperature: 0.9,
                    // CORRE√á√ÉO: Aumentado o limite de tokens de 512 para 1024 para garantir espa√ßo suficiente para o processamento interno (thoughtsTokenCount) E a cita√ß√£o, resolvendo o problema recorrente de MAX_TOKENS.
                    maxOutputTokens: 1024 // Limite aumentado para evitar que o modelo atinja o limite de tokens durante o processamento interno
                }
            };

            try {
                const result = await fetchWithExponentialBackoff(payload);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    const finalQuote = generatedText.trim();
                    const quoteWithIcon = `${icon} ${finalQuote}`;
                    
                    // 3. Exibe a cita√ß√£o
                    quoteTextElement.innerHTML = `<span class="text-3xl mr-2">${icon}</span> ${finalQuote}`;
                    updateUI(false, 'Cita√ß√£o gerada com sucesso! N√£o se esque√ßa da Suzane!');
                    
                    // 4. Salva no hist√≥rico
                    saveQuoteToHistory(quoteWithIcon);

                } else {
                    // --- Tratamento aprimorado de erro de resposta vazia/bloqueada ---
                    const candidate = result.candidates?.[0];
                    const blockReason = candidate?.finishReason;
                    const safetyRatings = candidate?.safetyRatings;

                    console.error('Resposta da API sem texto. Objeto de resultado completo:', result);
                    
                    let errorMessage = 'Erro ao processar a resposta do modelo. Tente novamente.';
                    if (blockReason === 'SAFETY') {
                        errorMessage = '‚ö†Ô∏è A cita√ß√£o foi bloqueada pelo filtro de seguran√ßa da API. Por favor, tente um tema diferente.';
                        console.warn('Bloqueado por seguran√ßa:', safetyRatings);
                    } else if (blockReason === 'RECITATION') {
                        errorMessage = '‚ö†Ô∏è O modelo detectou que a solicita√ß√£o pode recitar conte√∫do protegido. Por favor, reformule.';
                    } else if (blockReason === 'MAX_TOKENS') { // Tratamento espec√≠fico para o erro recorrente
                        errorMessage = '‚ö†Ô∏è O modelo atingiu o limite de tokens e cortou a cita√ß√£o. O limite foi aumentado, mas tente um assunto mais conciso.';
                    } else if (blockReason && blockReason !== 'STOP') {
                        errorMessage = `‚ö†Ô∏è Resposta do modelo incompleta (Raz√£o: ${blockReason}). Tente novamente.`;
                    }
                    
                    quoteTextElement.textContent = errorMessage;
                    updateUI(false, 'Houve um erro.');
                    // --- FIM Tratamento aprimorado ---
                }

            } catch (error) {
                quoteTextElement.textContent = 'ERRO: Falha ao se comunicar com a API ou erro de rede. Verifique o console.';
                updateUI(false, 'Houve um erro grave.');
                console.error('API Error:', error);
            }
        };

        // Fun√ß√£o para copiar a cita√ß√£o principal
        window.copyQuote = function() {
            // Pega o texto limpo da cita√ß√£o (sem a tag <span> do √≠cone)
            const quoteElementWithIcon = quoteTextElement.textContent.trim();
            
            if (quoteElementWithIcon && copyButton.disabled === false) {
                copyTextToClipboard(quoteElementWithIcon);
            }
        };

        // Configura√ß√£o inicial ao carregar a p√°gina
        window.onload = function() {
            updateUI(false, 'Pronto para gerar sua cita√ß√£o.');
            // Carrega e exibe o hist√≥rico ao iniciar
            displayHistory(loadHistory());
        };
    </script>
</body>
</html>